### TCP Header

##### 1. TCP Segment

TCP segment is basically the TCP Header plus the data that's right behind it and, of course, the data belongs to the uper layers 5,6,7.

<img src=https://i.imgur.com/BeXD13V.gif>

##### 2. TCP Header format.

<img src=https://i.imgur.com/y4Q4xrB.png>

###### 2.1. Source and Destination port number.

The port number allows us to identify the service or application our data or request must be sent to.
When a host, whether it be a simple computer or a dedicated server, offers various services such as http, ftp, telnet, all clients connecting to it must use a port number to choose which particular service they would like to use.

**Source Port:**

<img src=https://i.imgur.com/bYxzEm4.gif>

<img src=https://i.imgur.com/Z2V32BW.gif>

**Destination Port**

<img src=https://i.imgur.com/ByqxbA0.gif>

###### 2.2. TCP Sequence & Acknowledgement number.

The sequence and Acknowledgement fields are two of the many features that help us classify TCP as a Connection Oriented Protocol. 
As such, when data is sent through a TCP connection, the help the remote host keep tracks of the connection and ensure that no packet has been lost on the way to it's destination.

TCP utilizes positive acknowledgments, timeouts and retransmissions to ensure error-free, sequenced delivery of user data.
If the retransmission timer expires before an acknowledgment is received, data is retransmitted starting at the byte after the last acknowledged byte in the stream.

A further point worth mentioning is the fact that Sequence numbers are generated differently on each operating system.
Using special algorithims (and sometimes weak ones), an operating system will generate these numbers, which are used to track the packets sent or received, and since both Sequence and Acknowledgement fields are 32bit, there are 2^32= 4,294,967,296 possibilities of generating a different number!

**Initial Sequence Number**
When two host need to transfer data using the TCP  transport protocol, a new connection is created. This involves the first host that wishes to initiate  the connection, to generate what is called an Initial Sequence Number (ISN), which is first sequence number that's contained in the Sequence field we are looking at.

**Example of Sequence and Acknowledgement number.**

<img src=https://i.imgur.com/WyuWybQ.gif>

The diagram shows the establishment of a new connection to a web server - the Gate Way Server.
The first three packets are part of the 3-way handshake performed by TCP before any data is transferred between the two hosts.

- **Step 1.**

**Host A** wishes to download a webpage from the Gateway Server.
This requires a new connection between the two to be established so **Host A** sends a packet to the **Getway Server**. This packet has SYN Flag set and also contains the ISN generated by **Host A**'s Operating System, that's **1293906975**.
Since **Host A** is initialing the connection and hasn't received a reply from the **GateWay Server**, the **Acknowledgement** is set to zero(0).

In short, **Host A** is telling the **Getway Server** the following: "i'd like to initiate a new connection with you. My **Sequence** number is **1293906975**.

- **Step 2.**

The **Gateway Server** receives **Host A**'s request and generates a reply containing its own generated **ISN**, that is **3455719727**, and the next **Sequence number** it is expecting from **Host A** which is **1293906976**.
The Server also has the **SYN** & **ACK** flags set, acknowledging the previous packet it received and informing **Host A** of its own **Sequence number**.

In short, the **Gateway Server** is telling **Host A** the following: "I acknowledge your **sequence number** and expecting your next packet with **sequence number 1293906976**. My **sequence number** is **3455719727**".

- **Step 3.**

**Host A** receives the reply and now knows **Gateway's sequence number**.
It generates another **packet** to complete the connection.
This **packet** has the **ACK flag** set and also contains the **sequence number** that it expects the Gateway Server to use next, that is **3455719728**.

In short, **Host A** is telling the **Gateway Server** the following: "I acknowledge your **last packet**.
This **packet's sequence number** is **1293906976**, which is what you're expecting.
I'll also be expecting the **next packet** you send me to have a **sequence number** of **3455719728**".

Now, someone might be expecting the next packet to be sent from the Gateway Server, but this is not the case. You might recall that **Host A** initiated the connection because it wanted to download a web page from the **Gateway Server**. Since the **3-way TCP handshake** has been completed, a virtual connection between the two now exists and the **Gateway Server** is ready to listen to **Host A**'s request.

With this in mind, it's now time for **Host A** to ask for the webpage it wanted, which brings us to step number 4.

- **Step 4.**

In this step, **Host A** generates a **packet** with some data and sends it to the **Gateway Server**. The data tells the **Gateway Server** which webpage it would like sent.

Note that the sequence number of the segment in line 4 is the same as in line 3 because the ACK does not occupy sequence number space.

So keep in mind that any packets generated, which are simply acknowledgments (in other words, have only the ACK flag set and contain no data) to previously received packets, never increment the sequence number.


##### 3. TCP Header length.

**Header length** also represented as **Data offset**
**Defination:** "An interger that specifies the length of segment header meansured in 32-bit multiples"

##### 4. TCP Flag Options

###### 1ST FLAG - URGENT POINTER.
This flag is used to identify incoming data as 'urgent'.
Such incoming segments do not have to wait until the previous segments are consumed by the receiving end but are sent directly and processed immediately.

An Urgent Pointer could be used during a stream of data transfer where a host is sending data to an application running on a remote machine.
If a problem appears, the host machine needs to abort the data transfer and stop the data processing on the other end.
Under normal circumstances, the abort signal will be sent and queued at the remote machine until all previously sent data is processed, however, in this case, we need the abort signal to be processed immediately.

By setting the abort signal's segment Urgent Pointer flag to '1', the remote machine will not wait till all queued data is processed and then execute the abort. 
Instead, it will give that specific segment priority, processing it immediately and stopping all further data processing.

###### 2ND FLAG - ACKNOWLEDGEMENT

The **ACKnowledgement flag** is used to **acknowledge** the successful receipt of packets.

If you run a packet sniffer while transferring data using the TCP, you will notice that, in most cases, for every packet you send or receive, an ACKnowledgement follows. So if you received a packet from a remote host, then your workstation will most probably send one back with the ACK field set to "1".

In some cases where the sender requires one ACKnowledgement for every 3 packets sent, the receiving end will send the ACK expected once (the 3rd sequential packet is received). This is also called Windowing and is covered extensively in the pages that follow.

###### 3RD FLAG - PUSH

The **Push flag**, like the **Urgent flag**, exists to ensure that the data is given the priority (that it deserves) and is processed at the sending or receiving end.
This particular flag is used quite frequently at the beginning and end of a data transfer, affecting the way the data is handled at both ends.

###### 4TH FLAG - RESET (RST) FLAG

The **reset flag** is used when a segment arrives that is not intended for the current connection.
In other words, if you were to send a packet to a host in order to establish a connection, and there was no such service waiting to answer at the remote host, then the host would automatically reject your request and then send you a reply with the RST flag set.
This indicates that the remote host has reset the connection.

###### 5TH FLAG - SYNCHRONISATION FLAG

The fifth flag contained in the TCP Flag options is perhaps the most well know flag used in TCP communications.
As you might be aware, the SYN flag is initialy sent when establishing the classical 3-way handshake between two hosts.

###### 6TH FLAG - FIN FLAG

The final flag available is the FIN flag, standing for the word FINished.
This flag is used to tear down the virtual connections created using the previous flag (SYN), so because of this reason, the FIN flag always appears when the last packets are exchanged between a connection.

It is important to note that when a host sends a FIN flag to close a connection, it may continue to receive data until the remote host has also closed the connection, although this occurs only under certain circumstances.
Once the connection is teared down by both sides, the buffers set aside on each end for the connection are released.

